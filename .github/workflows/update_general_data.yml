name: Update General F1 Data (Drivers/Standings)

on:
  workflow_dispatch:
    inputs:
      year:
        description: 'Season Year to fetch'
        required: true
        default: '2024'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install requests firebase-admin pandas beautifulsoup4

    - name: Create Firebase Key File
      env:
        FIREBASE_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
      run: |
        if [ -z "$FIREBASE_KEY" ]; then
          echo "Error: FIREBASE_SERVICE_ACCOUNT_KEY secret is not set in GitHub Settings!"
          exit 1
        fi
        # Use python to write the file to avoid shell quoting issues
        python -c "import os; open('firebase-key.json', 'w').write(os.environ['FIREBASE_KEY'])"
      shell: bash

    - name: Fetch & Update Drivers/Teams
      env:
        FIREBASE_CREDENTIALS_PATH: firebase-key.json
      run: |
        echo "Running driver update script..."
        python scripts/upload_drivers.py --year ${{ inputs.year }}

    - name: Update Standings Data (TypeScript)
      run: |
        echo "Running standings update script..."
        # This updates the web/src/data/standings.ts file with fresh API data
        python scripts/update_standings.py

    # Since update_standings.py modifies a local file, we need to commit deeper changes back to the repo
    # so the website rebuilds with the new static data.
    - name: Commit & Push Changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore(data): Auto-update F1 standings for ${{ inputs.year }}"
        file_pattern: 'web/src/data/*.ts'
        branch: ${{ github.ref }}

    - name: Cleanup credentials
      if: always()
      run: rm -f firebase-key.json
